@model List<ServiceDetails>
@{
    ViewData["Title"] = "Microservices Details";
}

<div class="container-fluid mt-4">
    <h1 class="text-center mb-4">
        <i class="fas fa-cubes me-2"></i>Microservices Details
    </h1>
    
    <div class="row">
        <div class="col-lg-3">
            <div class="card shadow-sm sticky-top" style="top: 80px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Quick Navigation</h5>
                </div>
                <div class="list-group list-group-flush">
                    @foreach (var service in Model)
                    {
                        <a href="#@service.Service.Name.Replace(" ", "")" class="list-group-item list-group-item-action">
                            <span class="me-2">@service.Service.Icon</span>
                            @service.Service.Name
                        </a>
                    }
                </div>
            </div>
        </div>
        
        <div class="col-lg-9">
            @foreach (var serviceDetail in Model)
            {
                <div id="@serviceDetail.Service.Name.Replace(" ", "")" class="service-detail-section mb-5">
                    <div class="card shadow">
                        <div class="card-header" style="background-color: @serviceDetail.Service.Color; color: white;">
                            <h3 class="mb-0">
                                <span class="service-icon">@serviceDetail.Service.Icon</span>
                                @serviceDetail.Service.Name
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Overview</h5>
                                    <p>@serviceDetail.Service.Description</p>
                                    <p><strong>Technology Stack:</strong> @serviceDetail.Service.Technology</p>
                                </div>
                                <div class="col-md-6">
                                    <h5>Key Responsibilities</h5>
                                    <ul>
                                        @foreach (var responsibility in serviceDetail.Service.Responsibilities)
                                        {
                                            <li>@responsibility</li>
                                        }
                                    </ul>
                                </div>
                            </div>
                            
                            <hr />
                            
                            <!-- API Endpoints -->
                            <h5 class="mt-4 mb-3"><i class="fas fa-plug me-2"></i>API Endpoints</h5>
                            <div class="table-responsive">
                                <table class="table table-hover endpoint-table">
                                    <thead>
                                        <tr>
                                            <th>Method</th>
                                            <th>Path</th>
                                            <th>Description</th>
                                            <th>Response</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var endpoint in serviceDetail.Endpoints)
                                        {
                                            <tr>
                                                <td>
                                                    <span class="badge bg-@(endpoint.Method == "GET" ? "success" : endpoint.Method == "POST" ? "primary" : endpoint.Method == "PUT" ? "warning" : "danger")">
                                                        @endpoint.Method
                                                    </span>
                                                </td>
                                                <td><code>@endpoint.Path</code></td>
                                                <td>@endpoint.Description</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#endpointModal-@endpoint.GetHashCode()">
                                                        View Details
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Code Example -->
                            <h5 class="mt-4 mb-3"><i class="fas fa-code me-2"></i>Implementation Example</h5>
                            <div class="code-example-wrapper">
                                <pre class="line-numbers"><code class="language-csharp">@serviceDetail.Service.Code.Code</code></pre>
                            </div>
                            
                            <!-- Database Design -->
                            <h5 class="mt-4 mb-3"><i class="fas fa-database me-2"></i>Database Design</h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <p><strong>Type:</strong> @serviceDetail.Database.Type</p>
                                    <p><strong>Connection:</strong> <code>@serviceDetail.Database.ConnectionString</code></p>
                                </div>
                                <div class="col-md-8">
                                    <h6>Entities</h6>
                                    @foreach (var entity in serviceDetail.Database.Entities)
                                    {
                                        <div class="mb-3">
                                            <strong>@entity.Name</strong>
                                            <ul class="small">
                                                @foreach (var prop in entity.Properties)
                                                {
                                                    <li>
                                                        <code>@prop.Name : @prop.Type</code>
                                                        @if (prop.IsKey) { <span class="badge bg-warning">PK</span> }
                                                        @if (prop.IsRequired) { <span class="badge bg-info">Required</span> }
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                </div>
                            </div>
                            
                            <!-- Dependencies -->
                            <h5 class="mt-4 mb-3"><i class="fas fa-project-diagram me-2"></i>Service Dependencies</h5>
                            <div class="row">
                                @foreach (var dependency in serviceDetail.Dependencies)
                                {
                                    <div class="col-md-6 mb-3">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6>@dependency.ServiceName</h6>
                                                <p class="small mb-2">@dependency.Purpose</p>
                                                <p class="small mb-0"><strong>Communication:</strong> @dependency.CommunicationType</p>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                            
                            <!-- Deployment Configuration -->
                            <h5 class="mt-4 mb-3"><i class="fas fa-rocket me-2"></i>Deployment Configuration</h5>
                            <ul class="nav nav-tabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dockerfile-@serviceDetail.Service.Name.GetHashCode()" type="button">
                                        Dockerfile
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#k8s-@serviceDetail.Service.Name.GetHashCode()" type="button">
                                        Kubernetes
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#azure-@serviceDetail.Service.Name.GetHashCode()" type="button">
                                        Azure Config
                                    </button>
                                </li>
                            </ul>
                            <div class="tab-content mt-3">
                                <div class="tab-pane fade show active" id="dockerfile-@serviceDetail.Service.Name.GetHashCode()" role="tabpanel">
                                    <pre><code class="language-docker">@serviceDetail.Deployment.DockerfileContent</code></pre>
                                </div>
                                <div class="tab-pane fade" id="k8s-@serviceDetail.Service.Name.GetHashCode()" role="tabpanel">
                                    <pre><code class="language-yaml">@serviceDetail.Deployment.KubernetesYaml</code></pre>
                                </div>
                                <div class="tab-pane fade" id="azure-@serviceDetail.Service.Name.GetHashCode()" role="tabpanel">
                                    <pre><code class="language-json">@serviceDetail.Deployment.AzureConfig</code></pre>
                                </div>
                            </div>
                            
                            <!-- Security Configuration -->
                            <h5 class="mt-4 mb-3"><i class="fas fa-shield-alt me-2"></i>Security Configuration</h5>
                            <div class="row">
                                @foreach (var security in serviceDetail.Security)
                                {
                                    <div class="col-md-6">
                                        <div class="card mb-3">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">@security.Type</h6>
                                            </div>
                                            <div class="card-body">
                                                <p class="small">@security.Implementation</p>
                                                <details>
                                                    <summary>View Code</summary>
                                                    <pre class="mt-2"><code class="language-csharp">@security.Code</code></pre>
                                                </details>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Endpoint Detail Modals -->
                @foreach (var endpoint in serviceDetail.Endpoints)
                {
                    <div class="modal fade" id="endpointModal-@endpoint.GetHashCode()" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <span class="badge bg-@(endpoint.Method == "GET" ? "success" : endpoint.Method == "POST" ? "primary" : endpoint.Method == "PUT" ? "warning" : "danger")">
                                            @endpoint.Method
                                        </span>
                                        @endpoint.Path
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <h6>Description</h6>
                                    <p>@endpoint.Description</p>
                                    
                                    @if (!string.IsNullOrEmpty(endpoint.RequestBody))
                                    {
                                        <h6>Request Body</h6>
                                        <pre><code class="language-json">@endpoint.RequestBody</code></pre>
                                    }
                                    
                                    <h6>Response Body</h6>
                                    <pre><code class="language-json">@endpoint.ResponseBody</code></pre>
                                    
                                    @if (endpoint.Headers.Any())
                                    {
                                        <h6>Required Headers</h6>
                                        <ul>
                                            @foreach (var header in endpoint.Headers)
                                            {
                                                <li><code>@header</code></li>
                                            }
                                        </ul>
                                    }
                                    
                                    <h6>Controller Implementation</h6>
                                    <pre><code class="language-csharp">@endpoint.ControllerCode</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Smooth scrolling for navigation links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
            
            // Highlight active section in navigation
            const sections = document.querySelectorAll('.service-detail-section');
            const navLinks = document.querySelectorAll('.list-group-item');
            
            window.addEventListener('scroll', () => {
                let current = '';
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    const sectionHeight = section.clientHeight;
                    if (pageYOffset >= sectionTop - 100) {
                        current = section.getAttribute('id');
                    }
                });
                
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === '#' + current) {
                        link.classList.add('active');
                    }
                });
            });
            
            // Copy code functionality
            document.querySelectorAll('pre code').forEach(block => {
                const button = document.createElement('button');
                button.className = 'btn btn-sm btn-outline-light position-absolute top-0 end-0 m-2';
                button.innerHTML = '<i class="fas fa-copy"></i>';
                button.style.zIndex = '10';
                
                const pre = block.parentElement;
                pre.style.position = 'relative';
                pre.appendChild(button);
                
                button.addEventListener('click', () => {
                    navigator.clipboard.writeText(block.textContent).then(() => {
                        button.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            button.innerHTML = '<i class="fas fa-copy"></i>';
                        }, 2000);
                    });
                });
            });
        });
    </script>
}